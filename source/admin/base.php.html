<html>
    <head>
        <script type="text/javascript" src="../../js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shCore.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushJScript.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushPhp.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushXml.js"></script>
        <link href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shCoreEclipse.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shThemeWordpress.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

define( 'P2P_BOX_NONCE', 'p2p-box' );

/**
 * @package Administration
 */
class P2P_Box_Factory {

	function init() {
		add_action( 'add_meta_boxes', array( __CLASS__, 'add_meta_boxes' ) );
		add_action( 'save_post', array( __CLASS__, 'save_post' ), 10, 2 );
		add_action( 'wp_ajax_p2p_box', array( __CLASS__, 'wp_ajax_p2p_box' ) );
	}

	/**
	 * Add all the metaboxes.
	 */
	static function add_meta_boxes( $from ) {
		foreach ( P2P_Connection_Type::get() as $ctype_id =&gt; $args ) {
			$box = self::make_box( $ctype_id, $from );
			if ( !$box )
				continue;

			$box-&gt;register();
		}
	}

	/**
	 * Collect metadata from all boxes.
	 */
	function save_post( $post_id, $post ) {
		if ( 'revision' == $post-&gt;post_type || defined( 'DOING_AJAX' ) )
			return;

		// Custom fields
		if ( isset( $_POST['p2p_meta'] ) ) {
			foreach ( $_POST['p2p_meta'] as $p2p_id =&gt; $data ) {
				foreach ( $data as $key =&gt; $value ) {
					p2p_update_meta( $p2p_id, $key, $value );
				}
			}
		}

		// Ordering
		if ( isset( $_POST['p2p_order'] ) ) {
			foreach ( $_POST['p2p_order'] as $key =&gt; $list ) {
				foreach ( $list as $i =&gt; $p2p_id ) {
					p2p_update_meta( $p2p_id, $key, $i );
				}
			}
		}
	}

	/**
	 * Controller for all box ajax requests.
	 */
	function wp_ajax_p2p_box() {
		check_ajax_referer( P2P_BOX_NONCE, 'nonce' );

		$box = self::make_box( $_REQUEST['ctype_id'], $_REQUEST['post_type'] );
		if ( !$box )
			die(0);

		if ( !current_user_can( $box-&gt;ptype-&gt;cap-&gt;edit_posts ) )
			die(-1);

		$method = 'ajax_' . $_REQUEST['subaction'];

		$box-&gt;$method();
	}

	private static function make_box( $ctype_id, $post_type ) {
		$ctype = p2p_type( $ctype_id );

		if ( !$ctype )
			return false;

		if ( !$ctype-&gt;show_ui )
			return false;

		$directed = $ctype-&gt;find_direction( $post_type );
		if ( !$directed )
			return false;

		if ( !( $ctype-&gt;show_ui == 'any' || $ctype-&gt;show_ui == $directed-&gt;get_direction() ) )
			return false;

		return new P2P_Box( $directed, $post_type );
	}
}

P2P_Box_Factory::init();

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>