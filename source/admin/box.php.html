<html>
    <head>
        <script type="text/javascript" src="../../js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shCore.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushJScript.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushPhp.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushXml.js"></script>
        <link href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shCoreEclipse.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shThemeWordpress.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * @package Administration
 */
interface P2P_Field {
	function get_title();
	function render( $key, $p2p_id, $post_id );
}

/**
 * @package Administration
 */
class P2P_Box {
	private $ctype;

	private $current_ptype;

	public $ptype;

	private $columns;

	private static $extra_qv = array(
		'update_post_term_cache' =&gt; false,
		'update_post_meta_cache' =&gt; false,
		'post_status' =&gt; 'any',
	);

	function __construct( $ctype, $current_ptype ) {
		$this-&gt;ctype = $ctype;

		$this-&gt;current_ptype = $current_ptype;
		$this-&gt;ptype = $this-&gt;get_first_valid_ptype( $this-&gt;ctype-&gt;get_other_post_type() );

		if ( !class_exists( 'Mustache' ) )
			require dirname(__FILE__) . '/../mustache/Mustache.php';

		add_filter( 'posts_search', array( __CLASS__, '_search_by_title' ), 10, 2 );

		$this-&gt;init_columns();
	}

	private function get_first_valid_ptype( $post_types ) {
		do {
			$ptype = get_post_type_object( array_shift( $post_types ) );
		} while ( !$ptype &amp;&amp; !empty( $post_types ) );

		return $ptype;
	}

	public function register() {
		$title = $this-&gt;ctype-&gt;get_title();

		if ( empty( $title ) ) {
			$title = sprintf( __( 'Connected %s', P2P_TEXTDOMAIN ), $this-&gt;ptype-&gt;labels-&gt;name );
		}

		add_meta_box(
			'p2p-connections-' . $this-&gt;ctype-&gt;id,
			$title,
			array( $this, 'render' ),
			$this-&gt;current_ptype,
			$this-&gt;ctype-&gt;context,
			'default'
		);

		$this-&gt;init_scripts();
	}

	protected function init_scripts() {
		wp_enqueue_style( 'p2p-admin', plugins_url( 'box.css', __FILE__ ), array(), P2P_PLUGIN_VERSION );

		wp_enqueue_script( 'p2p-admin', plugins_url( 'box.js', __FILE__ ), array( 'jquery' ), P2P_PLUGIN_VERSION, true );
		wp_localize_script( 'p2p-admin', 'P2PAdmin', array(
			'nonce' =&gt; wp_create_nonce( P2P_BOX_NONCE ),
			'spinner' =&gt; admin_url( 'images/wpspin_light.gif' ),
			'deleteConfirmMessage' =&gt; __( 'Are you sure you want to delete all connections?', P2P_TEXTDOMAIN ),
		) );
	}

	protected function init_columns() {
		$this-&gt;columns = array(
			'delete' =&gt; new P2P_Field_Delete,
			'title' =&gt; new P2P_Field_Title( $this-&gt;ptype-&gt;labels-&gt;singular_name ),
		);

		foreach ( $this-&gt;ctype-&gt;fields as $key =&gt; $data ) {
			$this-&gt;columns[ $key ] = new P2P_Field_Generic( $data );
		}

		if ( $this-&gt;ctype-&gt;is_sortable() ) {
			$this-&gt;columns['order'] = new P2P_Field_Order( $this-&gt;ctype-&gt;sortable );
		}
	}

	function render( $post ) {
		$qv = self::$extra_qv;
		$qv['nopaging'] = true;

		$this-&gt;connected_posts = $this-&gt;ctype-&gt;get_connected( $post-&gt;ID, $qv )-&gt;posts;

		$data = array(
			'connections' =&gt; $this-&gt;render_connections_table( $post ),
			'create-connections' =&gt; $this-&gt;render_create_connections( $post )
		);

		$data_attr = array(
			'ctype_id' =&gt; $this-&gt;ctype-&gt;id,
			'prevent_duplicates' =&gt; $this-&gt;ctype-&gt;prevent_duplicates,
			'cardinality' =&gt; $this-&gt;ctype-&gt;accepts_single_connection() ? 'one' : 'many',
		);

		$data_attr_str = array();
		foreach ( $data_attr as $key =&gt; $value )
			$data_attr_str[] = &quot;data-$key='&quot; . $value . &quot;'&quot;;

		$data['attributes'] = implode( ' ', $data_attr_str );

		echo _p2p_mustache_render( 'box.html', $data );
	}

	protected function render_connections_table( $post ) {
		$data = array();

		if ( empty( $this-&gt;connected_posts ) )
			$data['hide'] = 'style=&quot;display:none&quot;';

		$tbody = '';
		foreach ( $this-&gt;connected_posts as $connected ) {
			$tbody .= $this-&gt;connection_row( $connected-&gt;p2p_id, $connected-&gt;ID );
		}
		$data['tbody'] = $tbody;

		foreach ( $this-&gt;columns as $key =&gt; $field ) {
			$data['thead'][] = array(
				'column' =&gt; $key,
				'title' =&gt; $field-&gt;get_title()
			);
		}

		return _p2p_mustache_render( 'table.html', $data );
	}

	protected function render_create_connections( $post ) {
		$data = array(
			'create-label' =&gt; __( 'Create connections:', P2P_TEXTDOMAIN )
		);

		if ( $this-&gt;ctype-&gt;accepts_single_connection() &amp;&amp; !empty( $this-&gt;connected_posts ) )
			$data['hide'] = 'style=&quot;display:none&quot;';

		// Search tab
		$tab_content = _p2p_mustache_render( 'tab-search.html', array(
			'placeholder' =&gt; $this-&gt;ptype-&gt;labels-&gt;search_items,
		) );

		$data['tabs'][] = array(
			'tab-id' =&gt; 'search',
			'tab-title' =&gt; __( 'Search', P2P_TEXTDOMAIN ),
			'is-active' =&gt; array(true),
			'tab-content' =&gt; $tab_content
		);

		// List tab
		$data['tabs'][] = array(
			'tab-id' =&gt; 'list',
			'tab-title' =&gt; __( 'View All', P2P_TEXTDOMAIN ),
			'tab-content' =&gt; $this-&gt;post_rows( $post-&gt;ID )
		);

		// Create post tab
		if ( $this-&gt;can_create_post() ) {
			$tab_content = _p2p_mustache_render( 'tab-create-post.html', array(
				'title' =&gt; $this-&gt;ptype-&gt;labels-&gt;add_new_item
			) );

			$data['tabs'][] = array(
				'tab-id' =&gt; 'create-post',
				'tab-title' =&gt; $this-&gt;ptype-&gt;labels-&gt;new_item,
				'tab-content' =&gt; $tab_content
			);
		}

		return _p2p_mustache_render( 'create-connections.html', $data );
	}

	protected function connection_row( $p2p_id, $post_id ) {
		$data = array();

		foreach ( $this-&gt;columns as $key =&gt; $field ) {
			$data['columns'][] = array(
				'column' =&gt; $key,
				'content' =&gt; $field-&gt;render( $key, $p2p_id, $post_id )
			);
		}

		return _p2p_mustache_render( 'table-row.html', $data );
	}

	protected function post_rows( $current_post_id, $page = 1, $search = '' ) {
		$args = array_merge( self::$extra_qv, array(
			'paged' =&gt; $page,
			'posts_per_page' =&gt; 5,
		) );

		if ( $search ) {
			$args['_p2p_box'] = true;
			$args['s'] = $search;
		}

		$query = $this-&gt;ctype-&gt;get_connectable( $current_post_id, $args );

		if ( empty( $query-&gt;posts ) )
			return false;

		$candidate = (object) array(
			'posts' =&gt; $query-&gt;posts,
			'current_page' =&gt; max( 1, $query-&gt;get('paged') ),
			'total_pages' =&gt; $query-&gt;max_num_pages
		);

		$data = array();

		$columns = array(
			'create' =&gt; new P2P_Field_Create,
			'title' =&gt; new P2P_Field_Title,
		);

		foreach ( $candidate-&gt;posts as $post ) {
			$row = array();

			foreach ( $columns as $key =&gt; $field ) {
				$row['columns'][] = array(
					'column' =&gt; $key,
					'content' =&gt; $field-&gt;render( $key, 0, $post-&gt;ID )
				);
			}

			$data['rows'][] = $row;
		}

		if ( $candidate-&gt;total_pages &gt; 1 ) {
			$data['navigation'] = array(
				'current-page' =&gt; number_format_i18n( $candidate-&gt;current_page ),
				'total-pages' =&gt; number_format_i18n( $candidate-&gt;total_pages ),

				'current-page-raw' =&gt; $candidate-&gt;current_page,
				'total-pages-raw' =&gt; $candidate-&gt;total_pages,

				'prev-inactive' =&gt; ( 1 == $candidate-&gt;current_page ) ? 'inactive' : '',
				'next-inactive' =&gt; ( $candidate-&gt;total_pages == $candidate-&gt;current_page ) ? 'inactive' : '',

				'prev-label' =&gt;  __( 'previous', P2P_TEXTDOMAIN ),
				'next-label' =&gt;  __( 'next', P2P_TEXTDOMAIN ),
				'of-label' =&gt; __( 'of', P2P_TEXTDOMAIN ),
			);
		}

		return _p2p_mustache_render( 'tab-list.html', $data, array( 'table-row' ) );
	}


	// Ajax handlers

	public function ajax_create_post() {
		if ( !$this-&gt;can_create_post() )
			die( -1 );

		$args = array(
			'post_title' =&gt; $_POST['post_title'],
			'post_author' =&gt; get_current_user_id(),
			'post_type' =&gt; $this-&gt;ptype-&gt;name
		);

		$args = apply_filters( 'p2p_new_post_args', $args, $this-&gt;ctype );

		$this-&gt;safe_connect( wp_insert_post( $args ) );
	}

	public function ajax_connect() {
		$this-&gt;safe_connect( $_POST['to'] );
	}

	private function safe_connect( $to ) {
		$from = absint( $_POST['from'] );
		$to = absint( $to );

		if ( !$from || !$to )
			die(-1);

		$p2p_id = $this-&gt;ctype-&gt;lose_direction()-&gt;connect( $from, $to );

		if ( $p2p_id )
			echo $this-&gt;connection_row( $p2p_id, $to );

		die;
	}

	public function ajax_disconnect() {
		P2P_Storage::delete( $_POST['p2p_id'] );

		die(1);
	}

	public function ajax_clear_connections() {
		$this-&gt;ctype-&gt;lose_direction()-&gt;disconnect_all( $_POST['post_id'] );

		die(1);
	}

	public function ajax_search() {
		$rows = $this-&gt;post_rows( $_GET['post_id'], $_GET['paged'], $_GET['s'] );

		if ( $rows ) {
			$results = compact( 'rows' );
		} else {
			$results = array(
				'msg' =&gt; $this-&gt;ptype-&gt;labels-&gt;not_found,
			);
		}

		die( json_encode( $results ) );
	}

	protected function can_create_post() {
		if ( !$this-&gt;ctype-&gt;can_create_post )
			return false;

		$ptype = $this-&gt;ctype-&gt;get_other_post_type();

		if ( count( $ptype ) &gt; 1 )
			return false;

		return current_user_can( $this-&gt;ptype-&gt;cap-&gt;edit_posts );
	}

	function _search_by_title( $sql, $wp_query ) {
		if ( $wp_query-&gt;is_search &amp;&amp; $wp_query-&gt;get( '_p2p_box' ) ) {
			list( $sql ) = explode( ' OR ', $sql, 2 );
			return $sql . '))';
		}

		return $sql;
	}
}


// Helpers

/**
 * @internal
 */
function _p2p_mustache_render( $file, $data, $partials = array() ) {
	$partial_data = array();
	foreach ( $partials as $partial ) {
		$partial_data[$partial] = _p2p_load_template( $partial . '.html' );
	}

	$m = new Mustache;

	return $m-&gt;render( _p2p_load_template( $file ), $data, $partial_data );
}

/**
 * @internal
 */
function _p2p_load_template( $file ) {
	return file_get_contents( dirname(__FILE__) . '/templates/' . $file );
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>