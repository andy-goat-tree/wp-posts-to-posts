<html>
    <head>
        <script type="text/javascript" src="../../js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shCore.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushJScript.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushPhp.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushXml.js"></script>
        <link href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shCoreEclipse.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shThemeWordpress.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

class P2P_Directed_Connection_Type {

	protected $ctype;
	protected $direction;

	protected $cardinality;
	protected $other_cardinality;

	function __construct( $ctype, $direction ) {
		$this-&gt;ctype = $ctype;
		$this-&gt;direction = $direction;

		$this-&gt;set_cardinality();
	}

	protected function set_cardinality() {
		$parts = explode( '-', $this-&gt;ctype-&gt;cardinality );

		if ( 'to' == $this-&gt;direction )
			$parts = array_reverse( $parts );

		$this-&gt;cardinality = ( 'one' == $parts[2] ) ? 'one' : 'many';
		$this-&gt;other_cardinality = ( 'one' == $parts[0] ) ? 'one' : 'many';
	}

	function __get( $key ) {
		return $this-&gt;ctype-&gt;$key;
	}

	public function get_direction() {
		return $this-&gt;direction;
	}

	public function lose_direction() {
		return $this-&gt;ctype;
	}

	public function accepts_single_connection() {
		return 'one' == $this-&gt;cardinality;
	}

	public function get_title() {
		$title = $this-&gt;title;

		if ( is_array( $title ) ) {
			$key = ( 'to' == $this-&gt;direction ) ? 'to' : 'from';

			if ( isset( $title[ $key ] ) )
				$title = $title[ $key ];
			else
				$title = '';
		}

		return $title;
	}

	public function get_other_post_type() {
		return 'from' == $this-&gt;direction ? $this-&gt;to : $this-&gt;from;
	}

	public function is_sortable() {
		return $this-&gt;sortable &amp;&amp; 'from' == $this-&gt;direction;
	}

	private function get_base_args( $extra_qv ) {
		$base_qv = ( 'from' == $this-&gt;direction ) ? $this-&gt;to_query_vars : $this-&gt;from_query_vars;

		return array_merge( $extra_qv, $base_qv, array(
			'suppress_filters' =&gt; false,
			'ignore_sticky_posts' =&gt; true
		) );
	}

	public function get_connected( $post_id, $extra_qv = array() ) {
		$args = $this-&gt;get_base_args( $extra_qv );

		$args['connected_query'] = array(
			'posts' =&gt; $post_id,
			'direction' =&gt; $this-&gt;direction
		);

		$args['connected_meta'] = $this-&gt;data;

		if ( $this-&gt;is_sortable() ) {
			_p2p_append( $args, array(
				'connected_orderby' =&gt; $this-&gt;sortable,
				'connected_order' =&gt; 'ASC',
				'connected_order_num' =&gt; true,
			) );
		}

		$args = apply_filters( 'p2p_connected_args', $args, $this );

		return new WP_Query( $args );
	}

	public function get_connected_to( $post_id, $extra_qv = array() ) {
		$this-&gt;direction = 'from';
		$result = $this-&gt;get_connected( $post_id, $extra_qv );
	}

	public function get_connectable( $post_id, $extra_qv = array() ) {
		$args = $this-&gt;get_base_args( $extra_qv );

		if ( 'one' == $this-&gt;other_cardinality ) {
			$connected = $this-&gt;get_connected( 'any', array( 'fields' =&gt; 'ids' ) );
			debug($this-&gt;direction, $connected-&gt;posts);
		} else if ( $this-&gt;prevent_duplicates ) {
			$connected = $this-&gt;get_connected( $post_id, array( 'fields' =&gt; 'ids' ) );
		}

		if ( !empty( $connected ) ) {
			_p2p_append( $args['post__not_in'], $connected-&gt;posts );
		}

		$args = apply_filters( 'p2p_connectable_args', $args, $this );

		return new WP_Query( $args );
	}

	public function get_p2p_id( $from, $to ) {
		$connected = $this-&gt;get_connected( $from, array( 'post__in' =&gt; array( $to ) ) );

		if ( !empty( $connected-&gt;posts ) )
			return (int) $connected-&gt;posts[0]-&gt;p2p_id;

		return false;
	}

	public function connect( $from, $to ) {
		if ( !get_post( $from ) || !get_post( $to ) )
			return false;

		$p2p_id = false;

		if ( 'one' == $this-&gt;cardinality ) {
			$connected = $this-&gt;get_connected( $from, array( 'fields' =&gt; 'ids' ) );
			if ( !empty( $connected-&gt;posts ) )
				return false;
		}

		if ( $this-&gt;prevent_duplicates ) {
			$p2p_id = $this-&gt;get_p2p_id( $from, $to );
		}

		if ( !$p2p_id ) {
			$args = array( $from, $to );

			if ( 'to' == $this-&gt;direction )
				$args = array_reverse( $args );

			$p2p_id = P2P_Storage::connect( $args[0], $args[1], $this-&gt;data );
		}

		return $p2p_id;
	}

	public function disconnect( $from, $to ) {
		return P2P_Storage::delete( $this-&gt;get_p2p_id( $from, $to ) );
	}

	public function disconnect_all( $from ) {
		$connected = $this-&gt;get_connected( $from );

		foreach ( wp_list_pluck( $connected-&gt;posts, 'p2p_id' ) as $p2p_id )
			P2P_Storage::delete( $p2p_id );
	}
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>