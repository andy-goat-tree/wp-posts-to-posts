<html>
    <head>
        <script type="text/javascript" src="../../js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shCore.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushJScript.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushPhp.js"></script>
        <script type="text/javascript" src="../../syntax_highlighter/scripts/shBrushXml.js"></script>
        <link href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shCoreEclipse.css" rel="stylesheet" type="text/css" />
        <link href="../../syntax_highlighter/styles/shThemeWordpress.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * Handles connected{_to|_from} query vars
 */
class P2P_Query {

	function init() {
		add_action( 'parse_query', array( 'P2P_Query', 'parse_legacy_qv' ) );
		add_filter( 'posts_clauses', array( 'P2P_Query', 'posts_clauses' ), 10, 2 );
		add_filter( 'the_posts', array( 'P2P_Query', 'the_posts' ), 11, 2 );
	}

	function parse_legacy_qv( $wp_query ) {
		$qv_map = array(
			'connected' =&gt; 'any',
			'connected_to' =&gt; 'to',
			'connected_from' =&gt; 'from',
		);

		foreach ( $qv_map as $key =&gt; $direction ) {
			$search = $wp_query-&gt;get( $key );
			if ( !empty( $search ) ) {
				$wp_query-&gt;set( 'connected_query', array(
					'posts' =&gt; $search,
					'direction' =&gt; $direction,
				) );

				$wp_query-&gt;set( $key, false );
			}
		}
	}

	function posts_clauses( $clauses, $wp_query ) {
		global $wpdb;

		$connected_query = $wp_query-&gt;get( 'connected_query' );
		if ( !is_array( $connected_query ) ) {
			return $clauses;
		}

		$defaults = array(
			'posts' =&gt; 'any',
			'direction' =&gt; 'any',
			'operator' =&gt; 'in'
		);

		$connected_query = array_merge( $defaults, $connected_query );

		$wp_query-&gt;_p2p_cache = true;

		$clauses['fields'] .= &quot;, $wpdb-&gt;p2p.*&quot;;

		$clauses['join'] .= &quot; INNER JOIN $wpdb-&gt;p2p&quot;;

		if ( 'any' == $connected_query['posts'] ) {
			$search = false;
		} else {
			$search = implode( ',', array_map( 'absint', (array) $connected_query['posts'] ) );
		}

		$direction = $connected_query['direction'];
		if ( !in_array( $direction, array( 'from', 'to', 'any' ) ) )
			$direction = 'any';

		if ( 'any' == $direction ) {
			if ( $search ) {
				$clauses['where'] .= &quot; AND (
					($wpdb-&gt;posts.ID = $wpdb-&gt;p2p.p2p_to AND $wpdb-&gt;p2p.p2p_from IN ($search)) OR
					($wpdb-&gt;posts.ID = $wpdb-&gt;p2p.p2p_from AND $wpdb-&gt;p2p.p2p_to IN ($search))
				)&quot;;
			} else {
				$clauses['where'] .= &quot; AND ($wpdb-&gt;posts.ID = $wpdb-&gt;p2p.p2p_to OR $wpdb-&gt;posts.ID = $wpdb-&gt;p2p.p2p_from)&quot;;
			}
		} else {
			$fields = array( 'p2p_from', 'p2p_to' );
			if ( 'from' == $direction )
				$fields = array_reverse( $fields );

			list( $from, $to ) = $fields;

			$clauses['where'] .= &quot; AND $wpdb-&gt;posts.ID = $wpdb-&gt;p2p.$from&quot;;
			if ( $search ) {
				$clauses['where'] .= &quot; AND $wpdb-&gt;p2p.$to IN ($search)&quot;;
			}
		}

		$connected_meta = $wp_query-&gt;get( 'connected_meta' );
		if ( !empty( $connected_meta ) ) {
			$meta_clauses = _p2p_meta_sql_helper( $connected_meta );
			foreach ( $meta_clauses as $key =&gt; $value ) {
				$clauses[ $key ] .= $value;
			}
		}

		// Handle ordering
		$connected_orderby = $wp_query-&gt;get( 'connected_orderby' );
		if ( $connected_orderby ) {
			$clauses['join'] .= $wpdb-&gt;prepare( &quot;
				LEFT JOIN $wpdb-&gt;p2pmeta AS p2pm_order ON (
					$wpdb-&gt;p2p.p2p_id = p2pm_order.p2p_id AND p2pm_order.meta_key = %s
				)
			&quot;, $connected_orderby );

			$connected_order = ( 'DESC' == strtoupper( $wp_query-&gt;get('connected_order') ) ) ? 'DESC' : 'ASC';

			$field = 'meta_value';

			if ( $wp_query-&gt;get('connected_order_num') )
				$field .= '+0';

			$clauses['orderby'] = &quot;p2pm_order.$field $connected_order&quot;;
		}

		return $clauses;
	}

	/**
	 * Pre-populates the p2p meta cache to decrease the number of queries.
	 */
	function the_posts( $the_posts, $wp_query ) {
		if ( empty( $the_posts ) )
			return $the_posts;

		if ( isset( $wp_query-&gt;_p2p_cache ) ) {
			update_meta_cache( 'p2p', wp_list_pluck( $the_posts, 'p2p_id' ) );
		}

		return $the_posts;
	}
}

P2P_Query::init();

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>